<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Gaming and VR Virtual Machines - Mistakes Were Made...</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	
	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="Mistakes Were Made..." rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">Mistakes Were Made...</div>
					
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/">
				
				<span class="menu__text">Home</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/posts/">
				
				<span class="menu__text">Posts</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/tags/">
				
				<span class="menu__text">Tags</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/categories/">
				
				<span class="menu__text">Categories</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Gaming and VR Virtual Machines</h1>
			
		</header>
<div class="post__toc toc">
	<div class="toc__title">Page content</div>
	<div class="toc__menu">
		
	</div>
</div>
<div class="content post__content clearfix">
			<div class="sect1">
<h2 id="_preamble">Preamble</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The intent of this setup is to provide a base Linux system for Development and native Gaming, while also providing the ability to run Windows-only Games (or Heavy Windows-only software). The setup will consist of 2TB SSD for Linux where a small 200GB Microsoft Windows 10 disk will also reside. The Windows 10 Virtual Machine will have direct access to several devices like SATA and Graphics. In my setup, the VM will have Three SATA SSDs (for Video Game storage) and a PCI-Express based Graphics Card. To facilitate the direct access to the Graphics Card we will be using Virtual Function I/O or VFIO. VFIO along with IOMMU allows VMs to directly access PCI devices (and PCI-Express devices). For this system I am using Arch Linux as the Linux Host Operating System due to its nature of being more bleeding-edge than Fedora. Using a Linux Distribution that is newer helps with patching and fixing problems that will arise with VFIO and PCI Pass-through. (Although, you should be able to apply any patches you might need to any other Linux distribution.) We are going to be building a Microsoft Windows 10 VM with type Q35, firmware OVMF, and with a qcow2 Primary (C:/) SATA disk.</p>
</div>
<div class="sect2">
<h3 id="_hardware_example">Hardware Example</h3>
<div class="ulist">
<ul>
<li>
<p>AMD Ryzen 9 3900X 12c/24t 3.8GHz CPU</p>
</li>
<li>
<p>64GB DDR4-3600 Dual Channel CL16 4x16GB RAM</p>
</li>
<li>
<p>ASUS Crosshair VIII Hero (Non-WiFi Edition, UEFI BIOS ver 1302)</p>
</li>
<li>
<p>AMD Sapphire Nitro+ RX 5700 XT 8GB Video Card (Slot 2, Win10 VM Guest)</p>
</li>
<li>
<p>AMD Sapphire Pulse RX Vega 56 8GB Video Card (Slot 1, Linux VM Host)</p>
</li>
<li>
<p>Samsung 970 EVO Plus 2TB (Linux Host Storage)</p>
</li>
<li>
<p>3x Samsung 860 QVO 1TB SSDs (Win10 VM Games Storage, SATA Passthrough)</p>
</li>
<li>
<p>PCI-Express x4 USB3 Controller (Win10 VM)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Linux Host GPU (Vega 56) will be in slot PCIE16_1 and the Win10 Guest GPU (5700 XT) will be in slot PCIE16_2. Review your motherboard&#8217;s manual for PCI-Express Bandwidth limitations, and place your GPUs appropriately to ensure the performance doesn&#8217;t suffer.</p>
</div>
</div>
<div class="sect2">
<h3 id="_bios_setup">BIOS Setup</h3>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You might need to enable the following in your bios if SVM is disabled by default.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ensure AMD SVM is Enabled by navigating to 'Advanced\CPU Configuration` and down to SVM Mode. Toggle to Enabled.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You might need to enable the following in your bios settings, but things should work by default or on auto.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ensure AMD IOMMU is Enabled by navigating to 'Advanced\AMD CBS\NBIO Common Options` and down to IOMMU. Toggle to Enabled.
Ensure ACS is Enabled by navigating to 'Advanced\AMD CBS\NBIO Common Options` and down to ACS Enable. Toggle to Enable.</p>
</div>
</div>
<div class="sect2">
<h3 id="_linux_kernel_patching_navi_10_patch">Linux Kernel Patching (Navi 10 Patch)</h3>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The Navi 10 Patch (or Vega 56 Patch) is required, and if not applied, will induce instability or system hanging of the Linux Host.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The first problem I ran into with my hardware is that the 5700XT is based on the Navi 10 architecture. Navi 10 support in the linux kernel is limited to the <code>amdgpu</code> kernel driver, which in our case will be replaced with the <code>vfio-pci</code> driver. The problem is encountered by attempting to reboot or hard reset the VM, and the GPU/PCI device isn&#8217;t properly reset and reinitialized. This functionality is called Function Level Reset or PCI Device Reset. The <code>amdgpu</code> driver in your kernel version may or may not have a patch/fix for Function Level Reset routines, but it doesn&#8217;t help anyways in our case. Luckly, we have a patch by 'gnif' that adds a PCI Device Reset to the PCI quirks driver.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_libvirt_passthrough_and_other_special_configuration">Libvirt, Passthrough, and Other Special Configuration</h2>
<div class="sectionbody">
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Information on Configuring Linux Drivers and VFIO is outlined in Appendix A.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following sections are the additions or modifications required to optimize the VM for VR and Gaming.</p>
</div>
<div class="sect2">
<h3 id="_cpu">CPU</h3>
<div class="paragraph">
<p>The following code section details the pinning of vCPUs to physical CPU Cores. The VM is emulating a 6c/12t and pinning those vCPUs to logical CPUs 2-6 and 14-19 (where the 3900X has 24 total logical CPUs and where Logical CPUs 0 and 12 are mapped to Core 0) will help with performance of the VM.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml">  <span class="nt">&lt;vcpu</span> <span class="na">placement=</span><span class="s">'static'</span> <span class="na">cpuset=</span><span class="s">'2-7,14-19'</span><span class="nt">&gt;</span>12<span class="nt">&lt;/vcpu&gt;</span>
  <span class="nt">&lt;iothreads&gt;</span>1<span class="nt">&lt;/iothreads&gt;</span>
  <span class="nt">&lt;cputune&gt;</span>
    <span class="nt">&lt;vcpupin</span> <span class="na">vcpu=</span><span class="s">'0'</span> <span class="na">cpuset=</span><span class="s">'2'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;vcpupin</span> <span class="na">vcpu=</span><span class="s">'1'</span> <span class="na">cpuset=</span><span class="s">'14'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;vcpupin</span> <span class="na">vcpu=</span><span class="s">'2'</span> <span class="na">cpuset=</span><span class="s">'3'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;vcpupin</span> <span class="na">vcpu=</span><span class="s">'3'</span> <span class="na">cpuset=</span><span class="s">'15'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;vcpupin</span> <span class="na">vcpu=</span><span class="s">'4'</span> <span class="na">cpuset=</span><span class="s">'4'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;vcpupin</span> <span class="na">vcpu=</span><span class="s">'5'</span> <span class="na">cpuset=</span><span class="s">'16'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;vcpupin</span> <span class="na">vcpu=</span><span class="s">'6'</span> <span class="na">cpuset=</span><span class="s">'5'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;vcpupin</span> <span class="na">vcpu=</span><span class="s">'7'</span> <span class="na">cpuset=</span><span class="s">'17'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;vcpupin</span> <span class="na">vcpu=</span><span class="s">'8'</span> <span class="na">cpuset=</span><span class="s">'6'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;vcpupin</span> <span class="na">vcpu=</span><span class="s">'9'</span> <span class="na">cpuset=</span><span class="s">'18'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;vcpupin</span> <span class="na">vcpu=</span><span class="s">'10'</span> <span class="na">cpuset=</span><span class="s">'7'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;vcpupin</span> <span class="na">vcpu=</span><span class="s">'11'</span> <span class="na">cpuset=</span><span class="s">'19'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;emulatorpin</span> <span class="na">cpuset=</span><span class="s">'0,12'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;iothreadpin</span> <span class="na">iothread=</span><span class="s">'1'</span> <span class="na">cpuset=</span><span class="s">'0,12'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/cputune&gt;</span>
  <span class="nt">&lt;cpu</span> <span class="na">mode=</span><span class="s">'host-passthrough'</span> <span class="na">check=</span><span class="s">'none'</span><span class="nt">&gt;</span>
    <span class="nt">&lt;topology</span> <span class="na">sockets=</span><span class="s">'1'</span> <span class="na">dies=</span><span class="s">'1'</span> <span class="na">cores=</span><span class="s">'6'</span> <span class="na">threads=</span><span class="s">'2'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">'require'</span> <span class="na">name=</span><span class="s">'topoext'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">'disable'</span> <span class="na">name=</span><span class="s">'amd-stibp'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/cpu&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_gpu_and_hdmi_audio_device">GPU and HDMI Audio Device</h3>
<div class="paragraph">
<p>To enable the use of your GPU for hardware acceleration you must find the PCI address for your GPU and its PCI functions. For the 5700XT, you should find the Main GPU address (function 0x00) and a HDMI Audio device (function 0x01). Newer nVidia cards will have two more functions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml">    <span class="nt">&lt;hostdev</span> <span class="na">mode=</span><span class="s">'subsystem'</span> <span class="na">type=</span><span class="s">'pci'</span> <span class="na">managed=</span><span class="s">'yes'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;source&gt;</span>
        <span class="nt">&lt;address</span> <span class="na">domain=</span><span class="s">'0x0000'</span> <span class="na">bus=</span><span class="s">'0x0f'</span> <span class="na">slot=</span><span class="s">'0x00'</span> <span class="na">function=</span><span class="s">'0x0'</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/source&gt;</span>
      <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">'pci'</span> <span class="na">domain=</span><span class="s">'0x0000'</span> <span class="na">bus=</span><span class="s">'0x06'</span> <span class="na">slot=</span><span class="s">'0x00'</span> <span class="na">function=</span><span class="s">'0x0'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/hostdev&gt;</span>
    <span class="nt">&lt;hostdev</span> <span class="na">mode=</span><span class="s">'subsystem'</span> <span class="na">type=</span><span class="s">'pci'</span> <span class="na">managed=</span><span class="s">'yes'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;source&gt;</span>
        <span class="nt">&lt;address</span> <span class="na">domain=</span><span class="s">'0x0000'</span> <span class="na">bus=</span><span class="s">'0x0f'</span> <span class="na">slot=</span><span class="s">'0x00'</span> <span class="na">function=</span><span class="s">'0x1'</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/source&gt;</span>
      <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">'pci'</span> <span class="na">domain=</span><span class="s">'0x0000'</span> <span class="na">bus=</span><span class="s">'0x09'</span> <span class="na">slot=</span><span class="s">'0x00'</span> <span class="na">function=</span><span class="s">'0x0'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/hostdev&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sata_pass_through">SATA (Pass-through)</h3>
<div class="paragraph">
<p>For storage of my games I used three SATA SSDs in a Windows Storage Setup (RAID 0). To emulate the same functionallity I passed through all three devices into KVM.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;disk</span> <span class="na">type=</span><span class="s">'block'</span> <span class="na">device=</span><span class="s">'disk'</span><span class="nt">&gt;</span>
  <span class="nt">&lt;driver</span> <span class="na">name=</span><span class="s">'qemu'</span> <span class="na">type=</span><span class="s">'raw'</span> <span class="na">cache=</span><span class="s">'writeback'</span> <span class="na">io=</span><span class="s">'threads'</span> <span class="na">discard=</span><span class="s">'unmap'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;source</span> <span class="na">dev=</span><span class="s">'/dev/disk/by-id/ata-Samsung_SSD_860_QVO_1TB_S4PGNF0M706444T'</span> <span class="na">index=</span><span class="s">'3'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">'sda'</span> <span class="na">bus=</span><span class="s">'scsi'</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/disk&gt;</span>
<span class="nt">&lt;disk</span> <span class="na">type=</span><span class="s">'block'</span> <span class="na">device=</span><span class="s">'disk'</span><span class="nt">&gt;</span>
  <span class="nt">&lt;driver</span> <span class="na">name=</span><span class="s">'qemu'</span> <span class="na">type=</span><span class="s">'raw'</span> <span class="na">cache=</span><span class="s">'writeback'</span> <span class="na">io=</span><span class="s">'threads'</span> <span class="na">discard=</span><span class="s">'unmap'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;source</span> <span class="na">dev=</span><span class="s">'/dev/disk/by-id/ata-Samsung_SSD_860_QVO_1TB_S4PGNF0M706466F'</span> <span class="na">index=</span><span class="s">'2'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">'sdb'</span> <span class="na">bus=</span><span class="s">'scsi'</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/disk&gt;</span>
<span class="nt">&lt;disk</span> <span class="na">type=</span><span class="s">'block'</span> <span class="na">device=</span><span class="s">'disk'</span><span class="nt">&gt;</span>
  <span class="nt">&lt;driver</span> <span class="na">name=</span><span class="s">'qemu'</span> <span class="na">type=</span><span class="s">'raw'</span> <span class="na">cache=</span><span class="s">'writeback'</span> <span class="na">io=</span><span class="s">'threads'</span> <span class="na">discard=</span><span class="s">'unmap'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;source</span> <span class="na">dev=</span><span class="s">'/dev/disk/by-id/ata-Samsung_SSD_860_QVO_1TB_S4PGNF0M706471J'</span> <span class="na">index=</span><span class="s">'1'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">'sdc'</span> <span class="na">bus=</span><span class="s">'scsi'</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/disk&gt;</span>
<span class="nt">&lt;controller</span> <span class="na">type=</span><span class="s">'scsi'</span> <span class="na">index=</span><span class="s">'0'</span> <span class="na">model=</span><span class="s">'virtio-scsi'</span><span class="nt">&gt;</span>
  <span class="nt">&lt;driver</span> <span class="na">queues=</span><span class="s">'8'</span> <span class="na">iothread=</span><span class="s">'1'</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/controller&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_usb_3_controller_pass_through_for_oculus_rift">USB 3 Controller (Pass-through for Oculus Rift)</h3>
<div class="paragraph">
<p>To enable the use of my Oculus Rift, I had to pass in a full USB 3.0 Controller to KVM.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml">    <span class="nt">&lt;hostdev</span> <span class="na">mode=</span><span class="s">'subsystem'</span> <span class="na">type=</span><span class="s">'pci'</span> <span class="na">managed=</span><span class="s">'yes'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;driver</span> <span class="na">name=</span><span class="s">'vfio'</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;source&gt;</span>
        <span class="nt">&lt;address</span> <span class="na">domain=</span><span class="s">'0x0000'</span> <span class="na">bus=</span><span class="s">'0x08'</span> <span class="na">slot=</span><span class="s">'0x00'</span> <span class="na">function=</span><span class="s">'0x0'</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/source&gt;</span>
      <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">'hostdev0'</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">'pci'</span> <span class="na">domain=</span><span class="s">'0x0000'</span> <span class="na">bus=</span><span class="s">'0x0c'</span> <span class="na">slot=</span><span class="s">'0x00'</span> <span class="na">function=</span><span class="s">'0x0'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/hostdev&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setup_looking_glass">Setup Looking Glass</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For the most part one can follow the official Installation instructions:
<a href="https://looking-glass.hostfission.com/wiki/Installation" class="bare">https://looking-glass.hostfission.com/wiki/Installation</a></p>
</div>
<div class="sect2">
<h3 id="_linux_changes">Linux Changes</h3>
<div class="listingblock">
<div class="title"><code>/etc/tmpfiles.d/10-looking-glass.conf</code>:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml">f /dev/shm/looking-glass 0660 user kvm -</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace &lt;user&gt; with your username.</p>
</div>
<div class="paragraph">
<p>Ask systemd-tmpfiles to create the shared memory file now without waiting to next boot</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">systemd-tmpfiles <span class="nt">--create</span> /etc/tmpfiles.d/10-looking-glass.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>Build looking-glass-client
Follow instructions from the Looking Glass website.</p>
</div>
<div class="paragraph">
<p>Modify Virtual Machine
Add the following before the closing domain xml:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">&lt;shmem <span class="nv">name</span><span class="o">=</span><span class="s1">'looking-glass'</span><span class="o">&gt;</span>
    &lt;model <span class="nb">type</span><span class="o">=</span><span class="s1">'ivshmem-plain'</span>/&gt;
    &lt;size <span class="nv">unit</span><span class="o">=</span><span class="s1">'M'</span><span class="o">&gt;</span>64&lt;/size&gt;
    &lt;<span class="nb">alias </span><span class="nv">name</span><span class="o">=</span><span class="s1">'shmem0'</span>/&gt;
    &lt;address <span class="nb">type</span><span class="o">=</span><span class="s1">'pci'</span> <span class="nv">domain</span><span class="o">=</span><span class="s1">'0x0000'</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">'0x08'</span> <span class="nv">slot</span><span class="o">=</span><span class="s1">'0x01'</span> <span class="k">function</span><span class="o">=</span><span class="s1">'0x0'</span>/&gt;
&lt;/shmem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Install 'looking-glass-host' on Windows 10
Download the Bleeding-Edge releases if the client is built from the master branch</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_appendix">Appendix</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_appendix_a_vfio_linux_configuration">Appendix A: VFIO &amp; Linux Configuration</h3>
<div class="listingblock">
<div class="title">/etc/default/grub:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">GRUB_CMDLINE_LINUX_DEFAULT</span><span class="o">=</span><span class="s2">"... mce=off video=efifb:off iommu=1 amd_iommu=on avic=1 rd.driver.pre=vfio-pci vfio-pci.ids=1002:731f,1002:ab38,1912:0014 pcie_acs_override=downstream ..."</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">/etc/modprobe.d/kvm.conf:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">options kvm <span class="nv">ignore_msrs</span><span class="o">=</span>1 <span class="nv">report_ignored_msrs</span><span class="o">=</span>0
options kvm_amd <span class="nv">avic</span><span class="o">=</span>1</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">/etc/modprobe.d/vfio.conf:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">softdep radeon pre: vfio-pci
softdep amdgpu pre: vfio-pci
softdep nouveau pre: vfio-pci
softdep drm pre: vfio-pci</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_appendix_b_linux_kernel_patching">Appendix B: Linux Kernel Patching</h3>
<div class="paragraph">
<p>There&#8217;s a great blog post on patching RHEL kernel patching by @Vincent Cojot:</p>
</div>
<div class="paragraph">
<p><a href="https://mojo.redhat.com/community/communities-at-red-hat/infrastructure/cloud-platforms-community-of-practice/blog/2019/09/19/when-you-need-that-kernel-hotfix-now" class="bare">https://mojo.redhat.com/community/communities-at-red-hat/infrastructure/cloud-platforms-community-of-practice/blog/2019/09/19/when-you-need-that-kernel-hotfix-now</a></p>
</div>
<div class="paragraph">
<p>For Arch Linux, use the following wiki page:</p>
</div>
<div class="paragraph">
<p><a href="https://wiki.archlinux.org/index.php/Kernel/Arch_Build_System" class="bare">https://wiki.archlinux.org/index.php/Kernel/Arch_Build_System</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_appendix_c_iommu_groups_and_device_selection">Appendix C: IOMMU Groups and Device Selection</h3>
<div class="sect3">
<h4 id="_iommu_groups">IOMMU Groups:</h4>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="c">#!/bin/bash</span>
<span class="nb">shopt</span> <span class="nt">-s</span> nullglob
<span class="k">for </span>g <span class="k">in</span> /sys/kernel/iommu_groups/<span class="k">*</span><span class="p">;</span> <span class="k">do
  </span><span class="nb">echo</span> <span class="s2">"IOMMU Group </span><span class="k">${</span><span class="nv">g</span><span class="p">##*/</span><span class="k">}</span><span class="s2">:"</span>
  <span class="k">for </span>d <span class="k">in</span> <span class="nv">$g</span>/devices/<span class="k">*</span><span class="p">;</span> <span class="k">do
    </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\t</span><span class="si">$(</span>lspci <span class="nt">-nns</span> <span class="k">${</span><span class="nv">d</span><span class="p">##*/</span><span class="k">}</span><span class="si">)</span><span class="s2">"</span>
  <span class="k">done
  </span><span class="nb">echo</span> <span class="s2">""</span>
<span class="k">done</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">IOMMU Group 0:
     00:01.0 Host bridge <span class="o">[</span>0600]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Starship/Matisse PCIe Dummy Host Bridge <span class="o">[</span>1022:1482]

IOMMU Group 1:
     00:01.1 PCI bridge <span class="o">[</span>0604]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Starship/Matisse GPP Bridge <span class="o">[</span>1022:1483]

IOMMU Group 10:
     00:07.1 PCI bridge <span class="o">[</span>0604]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Starship/Matisse Internal PCIe GPP Bridge 0 to bus[E:B] <span class="o">[</span>1022:1484]

IOMMU Group 11:
     00:08.0 Host bridge <span class="o">[</span>0600]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Starship/Matisse PCIe Dummy Host Bridge <span class="o">[</span>1022:1482]

IOMMU Group 12:
     00:08.1 PCI bridge <span class="o">[</span>0604]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Starship/Matisse Internal PCIe GPP Bridge 0 to bus[E:B] <span class="o">[</span>1022:1484]

IOMMU Group 13:
     00:08.2 PCI bridge <span class="o">[</span>0604]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Starship/Matisse Internal PCIe GPP Bridge 0 to bus[E:B] <span class="o">[</span>1022:1484]

IOMMU Group 14:
     00:08.3 PCI bridge <span class="o">[</span>0604]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Starship/Matisse Internal PCIe GPP Bridge 0 to bus[E:B] <span class="o">[</span>1022:1484]

IOMMU Group 15:
     00:14.0 SMBus <span class="o">[</span>0c05]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] FCH SMBus Controller <span class="o">[</span>1022:790b] <span class="o">(</span>rev 61<span class="o">)</span>
     00:14.3 ISA bridge <span class="o">[</span>0601]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] FCH LPC Bridge <span class="o">[</span>1022:790e] <span class="o">(</span>rev 51<span class="o">)</span>

IOMMU Group 16:
     00:18.0 Host bridge <span class="o">[</span>0600]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Matisse Device 24: Function 0 <span class="o">[</span>1022:1440]
     00:18.1 Host bridge <span class="o">[</span>0600]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Matisse Device 24: Function 1 <span class="o">[</span>1022:1441]
     00:18.2 Host bridge <span class="o">[</span>0600]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Matisse Device 24: Function 2 <span class="o">[</span>1022:1442]
     00:18.3 Host bridge <span class="o">[</span>0600]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Matisse Device 24: Function 3 <span class="o">[</span>1022:1443]
     00:18.4 Host bridge <span class="o">[</span>0600]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Matisse Device 24: Function 4 <span class="o">[</span>1022:1444]
     00:18.5 Host bridge <span class="o">[</span>0600]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Matisse Device 24: Function 5 <span class="o">[</span>1022:1445]
     00:18.6 Host bridge <span class="o">[</span>0600]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Matisse Device 24: Function 6 <span class="o">[</span>1022:1446]
     00:18.7 Host bridge <span class="o">[</span>0600]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Matisse Device 24: Function 7 <span class="o">[</span>1022:1447]

IOMMU Group 17:
     01:00.0 Non-Volatile memory controller <span class="o">[</span>0108]: Samsung Electronics Co Ltd NVMe SSD Controller SM981/PM981/PM983 <span class="o">[</span>144d:a808]

IOMMU Group 18:
     02:00.0 PCI bridge <span class="o">[</span>0604]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Matisse Switch Upstream <span class="o">[</span>1022:57ad]

IOMMU Group 19:
     03:02.0 PCI bridge <span class="o">[</span>0604]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Matisse PCIe GPP Bridge <span class="o">[</span>1022:57a3]

IOMMU Group 2:
     00:01.2 PCI bridge <span class="o">[</span>0604]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Starship/Matisse GPP Bridge <span class="o">[</span>1022:1483]

IOMMU Group 20:
     03:03.0 PCI bridge <span class="o">[</span>0604]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Matisse PCIe GPP Bridge <span class="o">[</span>1022:57a3]

IOMMU Group 21:
     03:04.0 PCI bridge <span class="o">[</span>0604]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Matisse PCIe GPP Bridge <span class="o">[</span>1022:57a3]

IOMMU Group 22:
     03:05.0 PCI bridge <span class="o">[</span>0604]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Matisse PCIe GPP Bridge <span class="o">[</span>1022:57a3]

IOMMU Group 23:
     03:08.0 PCI bridge <span class="o">[</span>0604]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Matisse PCIe GPP Bridge <span class="o">[</span>1022:57a4]

IOMMU Group 24:
     03:09.0 PCI bridge <span class="o">[</span>0604]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Matisse PCIe GPP Bridge <span class="o">[</span>1022:57a4]

IOMMU Group 25:
     03:0a.0 PCI bridge <span class="o">[</span>0604]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Matisse PCIe GPP Bridge <span class="o">[</span>1022:57a4]

IOMMU Group 26:
     04:00.0 PCI bridge <span class="o">[</span>0604]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Device <span class="o">[</span>1022:1470] <span class="o">(</span>rev c3<span class="o">)</span>

IOMMU Group 27:
     05:00.0 PCI bridge <span class="o">[</span>0604]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Device <span class="o">[</span>1022:1471]

IOMMU Group 28:
     06:00.0 VGA compatible controller <span class="o">[</span>0300]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD/ATI] Vega 10 XL/XT <span class="o">[</span>Radeon RX Vega 56/64] <span class="o">[</span>1002:687f] <span class="o">(</span>rev c3<span class="o">)</span>

IOMMU Group 29:
     06:00.1 Audio device <span class="o">[</span>0403]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD/ATI] Vega 10 HDMI Audio <span class="o">[</span>Radeon Vega 56/64] <span class="o">[</span>1002:aaf8]

IOMMU Group 3:
     00:02.0 Host bridge <span class="o">[</span>0600]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Starship/Matisse PCIe Dummy Host Bridge <span class="o">[</span>1022:1482]

IOMMU Group 30:
     07:00.0 Ethernet controller <span class="o">[</span>0200]: Realtek Semiconductor Co., Ltd. RTL8125 2.5GbE Controller <span class="o">[</span>10ec:8125]

IOMMU Group 31:
     08:00.0 USB controller <span class="o">[</span>0c03]: Renesas Technology Corp. uPD720201 USB 3.0 Host Controller <span class="o">[</span>1912:0014] <span class="o">(</span>rev 03<span class="o">)</span>

IOMMU Group 32:
     09:00.0 Ethernet controller <span class="o">[</span>0200]: Intel Corporation I211 Gigabit Network Connection <span class="o">[</span>8086:1539] <span class="o">(</span>rev 03<span class="o">)</span>

IOMMU Group 33:
     0a:00.0 Non-Essential Instrumentation <span class="o">[</span>1300]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Starship/Matisse Reserved SPP <span class="o">[</span>1022:1485]
     0a:00.1 USB controller <span class="o">[</span>0c03]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Matisse USB 3.0 Host Controller <span class="o">[</span>1022:149c]
     0a:00.3 USB controller <span class="o">[</span>0c03]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Matisse USB 3.0 Host Controller <span class="o">[</span>1022:149c]

IOMMU Group 34:
     0b:00.0 SATA controller <span class="o">[</span>0106]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] FCH SATA Controller <span class="o">[</span>AHCI mode] <span class="o">[</span>1022:7901] <span class="o">(</span>rev 51<span class="o">)</span>

IOMMU Group 35:
     0c:00.0 SATA controller <span class="o">[</span>0106]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] FCH SATA Controller <span class="o">[</span>AHCI mode] <span class="o">[</span>1022:7901] <span class="o">(</span>rev 51<span class="o">)</span>

IOMMU Group 36:
     0d:00.0 PCI bridge <span class="o">[</span>0604]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD/ATI] Navi 10 XL Upstream Port of PCI Express Switch <span class="o">[</span>1002:1478] <span class="o">(</span>rev c1<span class="o">)</span>

IOMMU Group 37:
     0e:00.0 PCI bridge <span class="o">[</span>0604]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD/ATI] Navi 10 XL Downstream Port of PCI Express Switch <span class="o">[</span>1002:1479]

IOMMU Group 38:
     0f:00.0 VGA compatible controller <span class="o">[</span>0300]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD/ATI] Navi 10 <span class="o">[</span>Radeon RX 5600 OEM/5600 XT / 5700/5700 XT] <span class="o">[</span>1002:731f] <span class="o">(</span>rev c1<span class="o">)</span>

IOMMU Group 39:
     0f:00.1 Audio device <span class="o">[</span>0403]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD/ATI] Navi 10 HDMI Audio <span class="o">[</span>1002:ab38]

IOMMU Group 4:
     00:03.0 Host bridge <span class="o">[</span>0600]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Starship/Matisse PCIe Dummy Host Bridge <span class="o">[</span>1022:1482]

IOMMU Group 40:
     10:00.0 Ethernet controller <span class="o">[</span>0200]: Mellanox Technologies MT26448 <span class="o">[</span>ConnectX EN 10GigE, PCIe 2.0 5GT/s] <span class="o">[</span>15b3:6750] <span class="o">(</span>rev b0<span class="o">)</span>

IOMMU Group 41:
     11:00.0 Non-Essential Instrumentation <span class="o">[</span>1300]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Starship/Matisse PCIe Dummy Function <span class="o">[</span>1022:148a]

IOMMU Group 42:
     12:00.0 Non-Essential Instrumentation <span class="o">[</span>1300]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Starship/Matisse Reserved SPP <span class="o">[</span>1022:1485]

IOMMU Group 43:
     12:00.1 Encryption controller <span class="o">[</span>1080]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Starship/Matisse Cryptographic Coprocessor PSPCPP <span class="o">[</span>1022:1486]

IOMMU Group 44:
     12:00.3 USB controller <span class="o">[</span>0c03]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Matisse USB 3.0 Host Controller <span class="o">[</span>1022:149c]

IOMMU Group 45:
     13:00.0 SATA controller <span class="o">[</span>0106]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] FCH SATA Controller <span class="o">[</span>AHCI mode] <span class="o">[</span>1022:7901] <span class="o">(</span>rev 51<span class="o">)</span>

IOMMU Group 46:
     14:00.0 SATA controller <span class="o">[</span>0106]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] FCH SATA Controller <span class="o">[</span>AHCI mode] <span class="o">[</span>1022:7901] <span class="o">(</span>rev 51<span class="o">)</span>

IOMMU Group 5:
     00:03.1 PCI bridge <span class="o">[</span>0604]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Starship/Matisse GPP Bridge <span class="o">[</span>1022:1483]

IOMMU Group 6:
     00:03.2 PCI bridge <span class="o">[</span>0604]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Starship/Matisse GPP Bridge <span class="o">[</span>1022:1483]

IOMMU Group 7:
     00:04.0 Host bridge <span class="o">[</span>0600]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Starship/Matisse PCIe Dummy Host Bridge <span class="o">[</span>1022:1482]

IOMMU Group 8:
     00:05.0 Host bridge <span class="o">[</span>0600]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Starship/Matisse PCIe Dummy Host Bridge <span class="o">[</span>1022:1482]

IOMMU Group 9:
     00:07.0 Host bridge <span class="o">[</span>0600]: Advanced Micro Devices, Inc. <span class="o">[</span>AMD] Starship/Matisse PCIe Dummy Host Bridge <span class="o">[</span>1022:1482]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_usb">USB</h4>
<div class="paragraph">
<p>To find out the USB Controller to PCI Bus mapping, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">sudo </span>lsusb <span class="nt">-v</span> 2&gt;/dev/null | <span class="nb">grep</span> <span class="s1">'^Bus\|iSerial'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="o">[</span>snelson@hkn-desktop ~]<span class="nv">$ </span><span class="nb">sudo </span>lsusb <span class="nt">-v</span> 2&gt;/dev/null | <span class="nb">grep</span> <span class="s1">'^Bus\|iSerial'</span>
Bus 006 Device 004: ID 2109:0812 VIA Labs, Inc. VL812 Hub
  iSerial                 0
Bus 006 Device 003: ID 2109:8110 VIA Labs, Inc. Hub
  iSerial                 0
Bus 006 Device 002: ID 2109:0812 VIA Labs, Inc. VL812 Hub
  iSerial                 0
Bus 006 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub
  iSerial                 1 0000:11:00.3
Bus 005 Device 012: ID 046d:0ab9 Logitech, Inc. USB2.0 Hub
  iSerial                 3 2009BAA00C58
Bus 005 Device 010: ID 1038:12ad SteelSeries ApS
  iSerial                 0
Bus 005 Device 007: ID 2109:2812 VIA Labs, Inc. VL812 Hub
  iSerial                 0
Bus 005 Device 011: ID 0fd9:0060 Elgato Systems GmbH
  iSerial                 3 AL19H1A02034
Bus 005 Device 005: ID 2109:2811 VIA Labs, Inc. Hub
  iSerial                 0
Bus 005 Device 009: ID 1b1c:1b66 Corsair
  iSerial                 3 32759A0C0169495F
Bus 005 Device 006: ID 1b1c:1b5d Corsair
  iSerial                 3 1400C024AF2609095A3F353AF5001BC0
Bus 005 Device 004: ID 2109:2813 VIA Labs, Inc. USB2.0 Hub
  iSerial                 0
Bus 005 Device 003: ID 1b1c:1b49 Corsair
  iSerial                 3 0201402EAF1E90C35A6DD6DBF5001BC2
Bus 005 Device 002: ID 2109:2812 VIA Labs, Inc. VL812 Hub
  iSerial                 0
Bus 005 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
  iSerial                 1 0000:11:00.3
Bus 004 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub
  iSerial                 1 0000:07:00.3
Bus 003 Device 002: ID 04e6:5116 SCM Microsystems, Inc. SCR331-LC1 / SCR3310 SmartCard Reader
  iSerial                 5 53311916202490
Bus 003 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
  iSerial                 1 0000:07:00.3
Bus 002 Device 004: ID 2833:0211 Oculus VR Rift Sensor
  iSerial                 3 WMTD303A200X4N
Bus 002 Device 003: ID 2833:3031 Oculus VR, Inc. Rift
  iSerial                 3 123456789A
Bus 002 Device 002: ID 2833:0211 Oculus VR Rift Sensor
  iSerial                 3 WMTD303Q602WUN
Bus 002 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub
  iSerial                 1 0000:07:00.1
Bus 001 Device 009: ID 0b05:18f3 ASUSTek Computer, Inc.
  iSerial                 3 9876543210
Bus 001 Device 007: ID 1b1c:1d00 Corsair
  iSerial               128 030501A9941C1D1C
Bus 001 Device 010: ID 1b1c:0c21 Corsair
  iSerial                 0
Bus 001 Device 008: ID 1b1c:0c1a Corsair
  iSerial                 3 2AC0000DC92046AFBF8F195CC11B00F5
Bus 001 Device 006: ID 05e3:0610 Genesys Logic, Inc. 4-port hub
  iSerial                 0
Bus 001 Device 004: ID 05e3:0610 Genesys Logic, Inc. 4-port hub
  iSerial                 0
Bus 001 Device 005: ID 2833:0330
  iSerial                 3 WMHD303A300M4
Bus 001 Device 003: ID 2833:0031 Oculus VR, Inc. Rift
  iSerial                 3 WMHD303A300M4C
Bus 001 Device 002: ID 2833:2031 Oculus VR, Inc. Rift
  iSerial                 3 123456789A
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
  iSerial                 1 0000:07:00.1</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_sata">SATA</h4>
<div class="paragraph">
<p>To find out the location of your Physical disk, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /dev/disk/by-id</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="o">[</span>snelson@hkn-desktop ~]<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /dev/disk/by-id
total 0
lrwxrwxrwx 1 root root  9 May 28 14:08 ata-Samsung_SSD_860_QVO_1TB_S4PGNF0M706444T -&gt; ../../sda
lrwxrwxrwx 1 root root 10 May 28 14:08 ata-Samsung_SSD_860_QVO_1TB_S4PGNF0M706444T-part1 -&gt; ../../sda1
lrwxrwxrwx 1 root root 10 May 28 14:08 ata-Samsung_SSD_860_QVO_1TB_S4PGNF0M706444T-part2 -&gt; ../../sda2
lrwxrwxrwx 1 root root 10 May 28 14:08 ata-Samsung_SSD_860_QVO_1TB_S4PGNF0M706444T-part3 -&gt; ../../sda3
lrwxrwxrwx 1 root root  9 May 28 14:08 ata-Samsung_SSD_860_QVO_1TB_S4PGNF0M706466F -&gt; ../../sdc
lrwxrwxrwx 1 root root 10 May 28 14:08 ata-Samsung_SSD_860_QVO_1TB_S4PGNF0M706466F-part1 -&gt; ../../sdc1
lrwxrwxrwx 1 root root 10 May 28 14:08 ata-Samsung_SSD_860_QVO_1TB_S4PGNF0M706466F-part2 -&gt; ../../sdc2
lrwxrwxrwx 1 root root 10 May 28 14:08 ata-Samsung_SSD_860_QVO_1TB_S4PGNF0M706466F-part3 -&gt; ../../sdc3
lrwxrwxrwx 1 root root  9 May 28 14:08 ata-Samsung_SSD_860_QVO_1TB_S4PGNF0M706471J -&gt; ../../sdb
lrwxrwxrwx 1 root root 10 May 28 14:08 ata-Samsung_SSD_860_QVO_1TB_S4PGNF0M706471J-part1 -&gt; ../../sdb1
lrwxrwxrwx 1 root root 10 May 28 14:08 ata-Samsung_SSD_860_QVO_1TB_S4PGNF0M706471J-part2 -&gt; ../../sdb2
lrwxrwxrwx 1 root root 10 May 28 14:08 ata-Samsung_SSD_860_QVO_1TB_S4PGNF0M706471J-part3 -&gt; ../../sdb3
lrwxrwxrwx 1 root root 13 May 28 12:36 nvme-Samsung_SSD_970_EVO_Plus_2TB_S59CNJ0N301646B -&gt; ../../nvme0n1
lrwxrwxrwx 1 root root 15 May 28 12:36 nvme-Samsung_SSD_970_EVO_Plus_2TB_S59CNJ0N301646B-part1 -&gt; ../../nvme0n1p1
lrwxrwxrwx 1 root root 15 May 28 12:36 nvme-Samsung_SSD_970_EVO_Plus_2TB_S59CNJ0N301646B-part3 -&gt; ../../nvme0n1p3
lrwxrwxrwx 1 root root 15 May 28 12:36 nvme-Samsung_SSD_970_EVO_Plus_2TB_S59CNJ0N301646B-part4 -&gt; ../../nvme0n1p4</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_appendix_d_libvirt_patch_for_amd_stibp_bug">Appendix D: libvirt patch for AMD-STIBP bug</h3>
<div class="paragraph">
<p>Add the following after the 'ibpb' and before 'amd-ssbd' features in '/usr/share/libvirt/cpu_map/x86_features.xml':</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml">  <span class="nt">&lt;feature</span> <span class="na">name=</span><span class="s">'amd-stibp'</span><span class="nt">&gt;</span>
    <span class="nt">&lt;cpuid</span> <span class="na">eax_in=</span><span class="s">'0x80000008'</span> <span class="na">ebx=</span><span class="s">'0x00008000'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/feature&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Afterwards you can add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml">  <span class="nt">&lt;cpu</span> <span class="na">mode=</span><span class="s">'host-passthrough'</span> <span class="na">check=</span><span class="s">'none'</span><span class="nt">&gt;</span>
    <span class="nt">&lt;topology</span> <span class="na">sockets=</span><span class="s">'1'</span> <span class="na">dies=</span><span class="s">'1'</span> <span class="na">cores=</span><span class="s">'6'</span> <span class="na">threads=</span><span class="s">'2'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">'require'</span> <span class="na">name=</span><span class="s">'topoext'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">'disable'</span> <span class="na">name=</span><span class="s">'amd-stibp'</span><span class="nt">/&gt;</span><span class="c">&lt;!-- add this --&gt;</span>
  <span class="nt">&lt;/cpu&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_appendix_e_full_libvirt_xml">Appendix E: Full LibVirt XML</h3>
<div class="paragraph">
<p><a href="/files/libvirt_win10vm.xml">Full LibVirt Win10 XML</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_references">References</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://wiki.archlinux.org/index.php/PCI_passthrough_via_OVMF" class="bare">https://wiki.archlinux.org/index.php/PCI_passthrough_via_OVMF</a></p>
</div>
<div class="paragraph">
<p><a href="https://forum.level1techs.com/t/navi-reset-kernel-patch/147547" class="bare">https://forum.level1techs.com/t/navi-reset-kernel-patch/147547</a></p>
</div>
<div class="paragraph">
<p><a href="https://www.reddit.com/r/VFIO/comments/gs33gy/getting_hostpassthrough_working_with_libvirt_630/" class="bare">https://www.reddit.com/r/VFIO/comments/gs33gy/getting_hostpassthrough_working_with_libvirt_630/</a></p>
</div>
<div class="paragraph">
<p><a href="https://www.tauceti.blog/post/linux-amd-x570-nvidia-gpu-pci-passthrough-1-the-hardware/" class="bare">https://www.tauceti.blog/post/linux-amd-x570-nvidia-gpu-pci-passthrough-1-the-hardware/</a></p>
</div>
<div class="paragraph">
<p><a href="https://www.tauceti.blog/post/linux-amd-x570-nvidia-gpu-pci-passthrough-5-looking-glass/" class="bare">https://www.tauceti.blog/post/linux-amd-x570-nvidia-gpu-pci-passthrough-5-looking-glass/</a></p>
</div>
<div class="paragraph">
<p><a href="https://heiko-sieger.info/running-windows-10-on-linux-using-kvm-with-vga-passthrough/" class="bare">https://heiko-sieger.info/running-windows-10-on-linux-using-kvm-with-vga-passthrough/</a></p>
</div>
<div class="paragraph">
<p><a href="https://www.reddit.com/r/VFIO/" class="bare">https://www.reddit.com/r/VFIO/</a></p>
</div>
</div>
</div>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/libvirt/" rel="tag">libvirt</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/kvm/" rel="tag">kvm</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/win10/" rel="tag">win10</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2020 Mistakes Were Made....
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>